#!/bin/bash

# Shell Doctor - Diagnostic script to verify dotfiles setup
# Checks symlinks, PATH configuration, and environment

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Counters
PASS=0
FAIL=0
WARN=0

# Load manifest
DOTFILES_DIR="${DOTFILES:-$HOME/Developer/dotfiles}"
if [ -f "$DOTFILES_DIR/install/lib/manifest.sh" ]; then
    source "$DOTFILES_DIR/install/lib/manifest.sh"
else
    echo "Error: Cannot find manifest.sh"
    exit 1
fi

print_header() {
    echo ""
    echo "═══════════════════════════════════════════"
    echo "  Shell Doctor - Dotfiles Health Check"
    echo "═══════════════════════════════════════════"
    echo ""
}

print_section() {
    echo ""
    printf "${BLUE}▶ %s${NC}\n" "$1"
    echo "───────────────────────────────────────────"
}

check_pass() {
    printf "${GREEN}✓${NC} %s\n" "$1"
    ((PASS++))
}

check_fail() {
    printf "${RED}✗${NC} %s\n" "$1"
    ((FAIL++))
}

check_warn() {
    printf "${YELLOW}⚠${NC} %s\n" "$1"
    ((WARN++))
}

check_info() {
    printf "${BLUE}ℹ${NC} %s\n" "$1"
}

# Check if running in correct shell
check_shell() {
    print_section "Shell Configuration"
    
    if [[ "$SHELL" == *"zsh"* ]]; then
        check_pass "Running zsh"
    else
        check_warn "Not running zsh (current: $SHELL)"
    fi
}

# Check symlinks using manifest
check_symlinks() {
    print_section "Symlink Status"
    
    for entry in "${DOTFILES_SYMLINKS[@]}"; do
        IFS=: read -r source target type <<< "$entry"
        local full_source="$DOTFILES_DIR/$source"
        
        # Check if source exists
        if [ ! -e "$full_source" ]; then
            check_warn "$(basename "$target") - source file missing"
            continue
        fi
        
        if [ -L "$target" ]; then
            local actual_source=$(readlink "$target")
            if [ "$actual_source" = "$full_source" ]; then
                check_pass "$(basename "$target") → correctly linked"
            else
                check_warn "$(basename "$target") → wrong location: $actual_source"
            fi
        elif [ -e "$target" ]; then
            check_warn "$(basename "$target") → exists but is not a symlink"
        else
            check_fail "$(basename "$target") → not found"
        fi
    done
}

# Check environment variables
check_environment() {
    print_section "Environment Variables"
    
    if [ -n "$DOTFILES" ]; then
        if [ "$DOTFILES" = "$HOME/Developer/dotfiles" ]; then
            check_pass "DOTFILES = $DOTFILES"
        else
            check_warn "DOTFILES = $DOTFILES (unusual location)"
        fi
    else
        check_fail "DOTFILES is not set"
    fi
    
    if [ -n "$DOTBIN" ]; then
        check_pass "DOTBIN = $DOTBIN"
    else
        check_fail "DOTBIN is not set"
    fi
    
    if [ -n "$DOTGIT" ]; then
        check_pass "DOTGIT = $DOTGIT"
    else
        check_fail "DOTGIT is not set"
    fi
    
    if [ -n "$DOTSHELL" ]; then
        check_pass "DOTSHELL = $DOTSHELL"
    else
        check_fail "DOTSHELL is not set"
    fi
    
    if [ -n "$EDITOR_GIT" ]; then
        check_pass "EDITOR_GIT = $EDITOR_GIT"
    else
        check_warn "EDITOR_GIT is not set"
    fi
}

# Check PATH
check_path() {
    print_section "PATH Configuration"
    
    local expected_paths=(
        "$DOTFILES_DIR/scripts/utils"
        "$DOTFILES_DIR/scripts/git"
        "$DOTFILES_DIR/scripts/shell"
    )
    
    for path in "${expected_paths[@]}"; do
        if [[ ":$PATH:" == *":$path:"* ]]; then
            local dir_name=$(basename "$path")
            check_pass "scripts/$dir_name in PATH"
        else
            local dir_name=$(basename "$path")
            check_fail "scripts/$dir_name NOT in PATH"
        fi
    done
    
    # Check if Homebrew is in PATH
    if command -v brew &> /dev/null; then
        check_pass "Homebrew in PATH: $(which brew)"
    else
        check_warn "Homebrew not found in PATH"
    fi
}

# Check key commands/tools
check_commands() {
    print_section "Key Commands & Tools"
    
    local commands=(
        "git"
        "brew"
        "zsh"
        "fzf"
        "gh"
        "swiftlint"
    )
    
    for cmd in "${commands[@]}"; do
        if command -v "$cmd" &> /dev/null; then
            check_pass "$cmd is available"
        else
            check_warn "$cmd not found"
        fi
    done
}

# Check shell functions
check_functions() {
    print_section "Shell Functions"
    
    local functions=(
        "diskspace"
        "delete-derived-data"
        "search_code"
    )
    
    for func in "${functions[@]}"; do
        if command -v "$func" &> /dev/null; then
            check_pass "$func() is loaded"
        else
            check_warn "$func() not found (may need to restart shell)"
        fi
    done
}

# Check file permissions
check_permissions() {
    print_section "File Permissions"
    
    local script_dirs=(
        "$DOTFILES_DIR/scripts/git"
        "$DOTFILES_DIR/scripts/shell"
        "$DOTFILES_DIR/scripts/utils"
    )
    
    local non_executable=0
    for dir in "${script_dirs[@]}"; do
        if [ -d "$dir" ]; then
            while IFS= read -r script; do
                if [ ! -x "$script" ]; then
                    ((non_executable++))
                fi
            done < <(find "$dir" -type f)
        fi
    done
    
    if [ $non_executable -eq 0 ]; then
        check_pass "All scripts are executable"
    else
        check_warn "$non_executable script(s) are not executable"
        check_info "Run: chmod +x $DOTFILES_DIR/scripts/*/* to fix"
    fi
}

# Print summary
print_summary() {
    echo ""
    echo "═══════════════════════════════════════════"
    echo "  Health Check Summary"
    echo "═══════════════════════════════════════════"
    printf "${GREEN}Passed:${NC}   %d\n" "$PASS"
    if [ $WARN -gt 0 ]; then
        printf "${YELLOW}Warnings:${NC} %d\n" "$WARN"
    fi
    if [ $FAIL -gt 0 ]; then
        printf "${RED}Failed:${NC}   %d\n" "$FAIL"
    fi
    echo "═══════════════════════════════════════════"
    echo ""
    
    if [ $FAIL -gt 0 ]; then
        echo "Some critical checks failed. Run the install script:"
        echo "  bash ~/Developer/dotfiles/install/install.sh"
        echo ""
        return 1
    elif [ $WARN -gt 0 ]; then
        echo "Setup is mostly working, but some warnings need attention."
        echo "You may need to restart your shell: exec zsh"
        echo ""
        return 0
    else
        echo "✨ Everything looks great! Your shell is properly configured."
        echo ""
        return 0
    fi
}

# Main execution
main() {
    print_header
    check_shell
    check_symlinks
    check_environment
    check_path
    check_commands
    check_functions
    check_permissions
    print_summary
}

main "$@"
